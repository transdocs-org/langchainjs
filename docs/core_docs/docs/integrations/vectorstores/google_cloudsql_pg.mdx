---
title: 适用于 PostgreSQL 的 Google Cloud SQL
---

export const quartoRawHtml = [
  `
<table>
<colgroup>
<col style="width: 11%" />
<col style="width: 24%" />
<col style="width: 55%" />
<col style="width: 8%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">类</th>
<th style="text-align: left;">包</th>
<th style="text-align: center;"><a href="https://python.langchain.com/docs/integrations/vectorstores/google_cloud_sql_pg/">Python 支持</a></th>
<th style="text-align: center;">包最新版本</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">PostgresVectorStore</td>
<td style="text-align: left;"><a href="https://www.npmjs.com/package/@langchain/google-cloud-sql-pg"><code>@langchain/google-cloud-sql-pg</code></a></td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">0.0.1</td>
</tr>
</tbody>
</table>
`,
];

[Cloud SQL](https://cloud.google.com/sql) 是一项完全托管的关系型数据库服务，提供高性能、无缝集成以及出色的可扩展性，支持 PostgreSQL 等数据库引擎。

本指南快速概述了如何使用适用于 PostgreSQL 的 Cloud SQL 通过 `PostgresVectorStore` 类存储向量嵌入。

## 概述

### 集成细节

<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[0] }} />

### 开始之前

要使用此包，您首先需要完成以下步骤：

1.  [选择或创建一个 Cloud Platform 项目。](https://developers.google.com/workspace/guides/create-project)
2.  [为您的项目启用计费。](https://cloud.google.com/billing/docs/how-to/modify-project#enable_billing_for_a_project)
3.  [启用 Cloud SQL Admin API。](https://console.cloud.google.com/flows/enableapi?apiid=sqladmin.googleapis.com)
4.  [设置身份验证。](https://cloud.google.com/docs/authentication)
5.  [创建一个 CloudSQL 实例](https://cloud.google.com/sql/docs/postgres/connect-instance-auth-proxy#create-instance)
6.  [创建一个 CloudSQL 数据库](https://cloud.google.com/sql/docs/postgres/create-manage-databases)
7.  [向数据库添加用户](https://cloud.google.com/sql/docs/postgres/create-manage-users)

### 身份验证

使用 `gcloud auth login` 命令对本地环境进行 Google Cloud 账户身份验证。

### 设置您的 Google Cloud 项目

将您的 Google Cloud 项目 ID 设置为在本地使用 Google Cloud 资源：

```python
gcloud config set project YOUR-PROJECT-ID
```

如果您不知道项目 ID，请尝试以下方法：  
\* 运行 `gcloud config list`。  
\* 运行 `gcloud projects list`。  
\* 查看支持页面：[查找项目 ID](https://support.google.com/googleapi/answer/7014113)。

## 设置 PostgresVectorStore 实例

要使用 PostgresVectorStore 库，您需要安装 `@langchain/google-cloud-sql-pg` 包，然后按照以下步骤操作。

首先，您需要登录到 Google Cloud 账户，并根据您的 Google Cloud 项目设置以下环境变量；这些变量将根据您希望配置（fromInstance、fromEngine、fromEngineArgs）PostgresEngine 实例的方式进行定义：

```python
PROJECT_ID="your-project-id"
REGION="your-project-region" // 示例："us-central1"
INSTANCE_NAME="your-instance"
DB_NAME="your-database-name"
DB_USER="your-database-user"
PASSWORD="your-database-password"
```

### 设置实例

要实例化 PostgresVectorStore，您首先需要通过 PostgresEngine 创建数据库连接，然后初始化向量存储表，最后调用 `.initialize()` 方法来实例化向量存储。

```python
import {
  Column,
  PostgresEngine,
  PostgresEngineArgs,
  PostgresVectorStore,
  PostgresVectorStoreArgs,
  VectorStoreTableArgs,
} from "@langchain/google-cloud-sql-pg";
import { SyntheticEmbeddings } from "@langchain/core/utils/testing"; // 用作嵌入服务
import * as dotenv from "dotenv";

dotenv.config();

const peArgs: PostgresEngineArgs = {
  user: process.env.DB_USER ?? "",
  password: process.env.PASSWORD ?? "",
};

// PostgresEngine 实例化
const engine: PostgresEngine = await PostgresEngine.fromInstance(
  process.env.PROJECT_ID ?? "",
  process.env.REGION ?? "",
  process.env.INSTANCE_NAME ?? "",
  process.env.DB_NAME ?? "",
  peArgs
);

const vectorStoreArgs: VectorStoreTableArgs = {
  metadataColumns: [new Column("page", "TEXT"), new Column("source", "TEXT")],
};

// 向量存储表初始化
await engine.initVectorstoreTable("my_vector_store_table", 768, vectorStoreArgs);
const embeddingService = new SyntheticEmbeddings({ vectorSize: 768 });

const pvectorArgs: PostgresVectorStoreArgs = {
  metadataColumns: ["page", "source"],
};

// PostgresVectorStore 实例化
const vectorStore = await PostgresVectorStore.initialize(
  engine,
  embeddingService,
  "my_vector_store_table",
  pvectorArgs
);
```

## 管理向量存储

### 将文档添加到向量存储中

要将文档添加到向量存储中，您可以选择是否传递 ID：

```python
import { v4 as uuidv4 } from "uuid";
import type { Document } from "@langchain/core/documents";

const document1: Document = {
  pageContent: "细胞的动力工厂是线粒体",
  metadata: { page: 0, source: "https://example.com" },
};

const document2: Document = {
  pageContent: "建筑物是由砖块建成的",
  metadata: { page: 1, source: "https://example.com" },
};

const document3: Document = {
  pageContent: "线粒体由脂质组成",
  metadata: { page: 2, source: "https://example.com" },
};

const document4: Document = {
  pageContent: "2024 年奥运会将在巴黎举行",
  metadata: { page: 3, source: "https://example.com" },
};

const documents = [document1, document2, document3, document4];

const ids = [uuidv4(), uuidv4(), uuidv4(), uuidv4()];

await vectorStore.addDocuments(documents, { ids: ids });
```

### 从向量存储中删除文档

您可以通过传递要删除的 ID 数组来删除一个或多个文档：

```python
// 删除一个文档
const id1 = ids[0];
await vectorStore.delete({ ids: [id1] });

// 删除多个文档
await vectorStore.delete({ ids: ids });
```

## 搜索文档

一旦创建了向量存储并添加了相关文档，您很可能会希望在运行链或代理时对其进行查询。

### 直接查询

执行简单的相似性搜索可以如下所示：

```python
const filter = `"source" = "https://example.com"`;

const results = await vectorStore.similaritySearch("生物学", 2, filter);

for (const doc of results) {
  console.log(`* ${doc.pageContent} [${JSON.stringify(doc.metadata, null)}]`);
}
```

如果您想执行相似性搜索并接收相应的分数，可以运行：

```python
const filter = `"source" = "https://example.com"`;
const resultsWithScores = await vectorStore.similaritySearchWithScore(
  "生物学",
  2,
  filter
);

for (const [doc, score] of resultsWithScores) {
  console.log(
    `* [SIM=${score.toFixed(3)}] ${doc.pageContent} [${JSON.stringify(doc.metadata)}]`
  );
}
```

### 通过最大边缘相关搜索进行查询

最大边缘相关性（Maximal Marginal Relevance）会优化与查询的相似性和所选文档之间的多样性。

```python
const options = {
  k: 4,
  filter: `"source" = 'https://example.com'`,
};

const results = await vectorStoreInstance.maxMarginalRelevanceSearch("生物学", options);

for (const doc of results) {
  console.log(`* ${doc.pageContent} [${JSON.stringify(doc.metadata, null)}]`);
}
```